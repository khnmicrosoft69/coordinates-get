<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Device Coordinates with QR</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#9aa6b2;
      --success:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:24px; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,#071427 0%,#071018 100%); color:#e6eef6;
    }
    .wrap{max-width:720px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center}
    h1{font-size:1.25rem;margin:0}
    p.lead{color:var(--muted);margin:6px 0 18px;font-size:.95rem}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,11,.6)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .row{display:flex;gap:8px;align-items:center}
    .big{font-size:1.1rem;font-weight:600}
    .muted{color:var(--muted);font-size:.9rem}
    button{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06); color:inherit; padding:8px 12px;border-radius:9px;
      cursor:pointer; font-weight:600;
    }
    button.primary{border-color:var(--accent); box-shadow:0 6px 18px rgba(6,182,212,.06)}
    button.ghost{background:transparent;border:1px dashed rgba(255,255,255,.04)}
    .status{padding:8px 10px;border-radius:8px;font-weight:600}
    .status.ok{background:rgba(16,185,129,.08);color:var(--success)}
    .status.err{background:rgba(239,68,68,.08);color:var(--danger)}
    pre{white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.15);padding:10px;border-radius:8px}
    footer{margin-top:14px;color:var(--muted);font-size:.85rem}
    #qrcode {
      margin-top: 20px;
      display: flex;
      justify-content: center;
    }
    @media (max-width:560px){
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Device Coordinates with QR</h1>
    </header>
    <p class="lead">Shows your current latitude & longitude, accuracy and timestamp. Click <strong>Start tracking</strong> to get live updates and generate a QR code of your location.</p>

    <div class="card" id="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Permission status:</div>
          <div id="perm" class="status muted" style="display:inline-block;margin-top:6px">unknown</div>
        </div>

        <div style="display:flex;gap:8px">
          <button id="startBtn" class="primary">Start tracking</button>
          <button id="stopBtn" class="ghost" disabled>Stop</button>
        </div>
      </div>

      <div class="grid" style="margin-top:14px">
        <div>
          <div class="muted">Latitude</div>
          <div id="lat" class="big">—</div>
        </div>
        <div>
          <div class="muted">Longitude</div>
          <div id="lon" class="big">—</div>
        </div>

        <div>
          <div class="muted">Accuracy (meters)</div>
          <div id="acc" class="big">—</div>
        </div>
        <div>
          <div class="muted">Altitude</div>
          <div id="alt" class="big">—</div>
        </div>

        <div style="grid-column:1 / -1">
          <div class="muted">Timestamp</div>
          <div id="ts" class="muted">—</div>
        </div>

        <div style="grid-column:1 / -1">
          <div class="muted">Raw coordinates</div>
          <pre id="raw">—</pre>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="copyBtn">Copy coordinates</button>
            <a id="gmaps" href="#" target="_blank" rel="noopener" style="display:inline-block;text-decoration:none">
              <button>Open in Google Maps</button>
            </a>
            <button id="getOnce" class="ghost">Get once</button>
          </div>
        </div>
      </div>

      <div id="qrcode"></div>
    </div>

    <footer>
      <div>Notes: The browser will ask for location permission. Best accuracy on mobile with GPS enabled. If permission denied, check browser settings.</div>
    </footer>
  </div>

  <!-- QRCode.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    // Elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const getOnceBtn = document.getElementById('getOnce');
    const copyBtn = document.getElementById('copyBtn');
    const permEl = document.getElementById('perm');
    const latEl = document.getElementById('lat');
    const lonEl = document.getElementById('lon');
    const accEl = document.getElementById('acc');
    const altEl = document.getElementById('alt');
    const tsEl = document.getElementById('ts');
    const rawEl = document.getElementById('raw');
    const gmapsLink = document.getElementById('gmaps');
    const qrcodeContainer = document.getElementById('qrcode');

    let watchId = null;

    function showPermission(status) {
      permEl.textContent = status;
      permEl.className = 'status ' + (status === 'granted' ? 'ok' : status === 'denied' ? 'err' : '');
    }

    function formatTimestamp(ms) {
      if (!ms) return '—';
      const d = new Date(ms);
      return d.toLocaleString();
    }

    function updateView(pos) {
      if (!pos) return;
      const { latitude, longitude, accuracy, altitude } = pos.coords;
      latEl.textContent = latitude.toFixed(6);
      lonEl.textContent = longitude.toFixed(6);
      accEl.textContent = accuracy == null ? '—' : `${accuracy} m`;
      altEl.textContent = altitude == null ? '—' : `${altitude} m`;
      tsEl.textContent = formatTimestamp(pos.timestamp);
      rawEl.textContent = JSON.stringify({
        latitude, longitude, accuracy, altitude, timestamp: new Date(pos.timestamp).toISOString()
      }, null, 2);

      gmapsLink.href = `https://www.google.com/maps/search/?api=1&query=${latitude},${longitude}`;
      gmapsLink.title = `Open ${latitude.toFixed(6)}, ${longitude.toFixed(6)} in Google Maps`;

      // Generate QR code with coordinates
      const coordsText = `${latitude.toFixed(6)},${longitude.toFixed(6)}`;
      qrcodeContainer.innerHTML = ''; // clear previous QR
      QRCode.toCanvas(coordsText, { width: 180 }, function (error, canvas) {
        if (error) {
          console.error(error);
          return;
        }
        qrcodeContainer.appendChild(canvas);
      });
    }

    function handleError(err) {
      console.warn('Geolocation error', err);
      latEl.textContent = '—';
      lonEl.textContent = '—';
      accEl.textContent = '—';
      altEl.textContent = '—';
      tsEl.textContent = err.message || 'error';
      rawEl.textContent = `Error: ${err.code} — ${err.message || ''}`;
      showPermission('denied');
      qrcodeContainer.innerHTML = '';
    }

    // Start live tracking
    startBtn.addEventListener('click', () => {
      if (!('geolocation' in navigator)) {
        alert('Geolocation is not supported by this browser.');
        return;
      }
      watchId = navigator.geolocation.watchPosition(
        pos => {
          updateView(pos);
          showPermission('granted');
        },
        err => {
          handleError(err);
        },
        { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
      );
      startBtn.disabled = true;
      stopBtn.disabled = false;
    });

    // Stop tracking
    stopBtn.addEventListener('click', () => {
      if (watchId != null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      showPermission('stopped');
      qrcodeContainer.innerHTML = '';
    });

    // Single one-time fetch
    getOnceBtn.addEventListener('click', () => {
      if (!('geolocation' in navigator)) {
        alert('Geolocation is not supported by this browser.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => { updateView(pos); showPermission('granted'); },
        err => { handleError(err); },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );
    });

    // Copy coordinates
    copyBtn.addEventListener('click', async () => {
      const lat = latEl.textContent;
      const lon = lonEl.textContent;
      if (!lat || lat === '—' || !lon || lon === '—') {
        alert('No coordinates to copy.');
        return;
      }
      const text = `${lat}, ${lon}`;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy coordinates', 1200);
      } catch (e) {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); alert('Copied to clipboard (fallback)'); } finally { ta.remove(); }
      }
    });

    // Try to query Permissions API for better UI
    async function checkPermission() {
      if (!navigator.permissions) {
        showPermission('unknown');
        return;
      }
      try {
        const status = await navigator.permissions.query({ name: 'geolocation' });
        showPermission(status.state);
        status.onchange = () => showPermission(status.state);
      } catch (e) {
        showPermission('unknown');
      }
    }

    checkPermission();

    window.addEventListener('beforeunload', () => {
      if (watchId != null) navigator.geolocation.clearWatch(watchId);
    });
  </script>
</body>
</html>
